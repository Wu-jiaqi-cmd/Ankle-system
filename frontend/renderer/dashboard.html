<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>上传</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    #demoBox{width:400px;height:225px;}
    #camBox {width:400px;height:225px;background:#000;display:none;position:relative;}
    canvas   {position:absolute;top:0;left:0;}
  </style>
</head>
<body class="p-4">
  <a class="btn btn-sm btn-secondary" href="history.html">查看历史</a>

  <h4 class="mt-3">演示视频</h4>
  <div id="demoBox" class="border rounded">
    <video id="demo" src="demo.mp4" controls width="100%" height="100%"></video>
  </div>

  <h4 class="mt-4">1. 选择长视频上传</h4>
  <input type="file" id="fileInput" accept="video/*" class="form-control w-50">
  <button class="btn btn-primary mt-2" onclick="uploadFile()">上传并评估</button>

  <h4 class="mt-4">2. 实时拍摄（含骨架）</h4>
  <button id="startCam"  class="btn btn-success" onclick="startCamera()">开始拍摄</button>
  <button id="stopCam"   class="btn btn-danger  d-none" onclick="stopCamera()">停止拍摄</button>

  <!-- 摄像头区域 -->
  <div id="camBox" class="border rounded mt-2">
    <video id="cam" autoplay muted width="100%" height="100%"></video>
    <canvas id="canvas" width="400" height="225"></canvas>
  </div>

  <div id="result" class="mt-4 alert alert-info" style="display:none;"></div>

  <script>
    const API = 'http://localhost:5000';
    let mediaRecorder, stream, chunks = [];

    // ---------- 长视频上传 ---------- //
    async function uploadFile(){
      const file = document.getElementById('fileInput').files[0];
      if(!file){ alert('请选择视频'); return; }
      const fd = new FormData();
      fd.append('video', file);
      fd.append('uid', localStorage.uid);
      document.getElementById('result').style.display = 'block';
      document.getElementById('result').textContent = '上传/分析中，请稍候...';
      const res = await fetch(`${API}/upload`, {method: 'POST', body: fd}).then(r => r.json());
      location.href = `result.html?video=${encodeURIComponent(res.videoPath)}&score=${res.score}&risk=${res.risk}&advice=${encodeURIComponent(res.advice)}`;
    }

    // ---------- 摄像头控制 ---------- //
    async function startCamera(){
      startCam.classList.add('d-none');
      stopCam.classList.remove('d-none');
      document.getElementById('camBox').style.display = 'block';
      stream = await navigator.mediaDevices.getUserMedia({video: {width: 400, height: 225}});
      cam.srcObject = stream;
      cam.onloadedmetadata = () => startMediapipe();
      // 录制 MP4
      chunks = [];
      mediaRecorder = new MediaRecorder(stream, {mimeType: 'video/mp4'});
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, {type: 'video/mp4'});
        const file = new File([blob], 'capture.mp4', {type: 'video/mp4'});
        const fd = new FormData();
        fd.append('video', file);
        fd.append('uid', localStorage.uid);
        const res = await fetch(`${API}/upload`, {method: 'POST', body: fd}).then(r => r.json());
        location.href = `result.html?video=${encodeURIComponent(res.videoPath)}&score=${res.score}&risk=${res.risk}&advice=${encodeURIComponent(res.advice)}`;
      };
      mediaRecorder.start();
    }
    function stopCamera(){
      if(mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
      if(stream) stream.getTracks().forEach(t => t.stop());
      cancelAnimationFrame(loopId);
    }

    // ---------- 实时 Mediapipe 画骨架 ---------- //
    let loopId;
    const canvas = document.getElementById('canvas');
    const ctx    = canvas.getContext('2d');
    async function startMediapipe(){
      const mpPose = await import('https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469407/pose_wasm.js');
      const pose = new mpPose.Pose({locateFile: (file) =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469407/${file}`});
      pose.setOptions({modelComplexity: 1, smoothLandmarks: true,
                       minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
      pose.onResults(onResults);

      async function detect(){
        if(cam.videoWidth === 0) return;
        await pose.send({image: cam});
        loopId = requestAnimationFrame(detect);
      }
      detect();
    }
    function onResults(results){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
      if(results.poseLandmarks){
        // 画骨架
        mp.drawConnectors(ctx, results.poseLandmarks, mp.POSE_CONNECTIONS, {color: '#00FF00'});
        mp.drawLandmarks(ctx, results.poseLandmarks, {color: '#FF0000', fillColor: '#FF0000'});
        // 角度
        const lm = results.poseLandmarks;
        const heel  = {x: lm[30].x * 400, y: lm[30].y * 225};
        const ankle = {x: lm[28].x * 400, y: lm[28].y * 225};
        const toe   = {x: lm[32].x * 400, y: lm[32].y * 225};
        const ang = Math.abs(Math.atan2(toe.y - ankle.y, toe.x - ankle.x) -
                             Math.atan2(heel.y - ankle.y, heel.x - ankle.x)) * 180 / Math.PI;
        ctx.fillStyle = '#FFFF00'; ctx.font = '16px Arial';
        ctx.fillText(`背屈角度: ${ang.toFixed(1)}°`, 10, 25);
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.5.1675469407/drawing_utils.js"></script>
</body>
</html>
